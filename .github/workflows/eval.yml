name: ZeroClaw Agent Eval

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  prompt-regression:
    name: PromptSpec Regression Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Run prompt pack validation
        run: node -e "
          import('./promptos-bridge/index.js').then(async m => {
            console.log('PromptOS bridge loaded OK');
            process.exit(0);
          }).catch(e => {
            console.error('PromptOS bridge load failed:', e.message);
            process.exit(1);
          });
        "

  policy-tests:
    name: Policy + RBAC Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Run policy tests
        run: |
          node --input-type=module <<'EOF'
          import { PolicyEngine } from './control-plane/policy.js';
          import { GovernanceEngine } from './control-plane/governance.js';

          const policy = new PolicyEngine();
          const gov = new GovernanceEngine();

          // Test RBAC
          console.assert(policy.checkPromptAllowed('engineer', 'ship.plan'), 'engineer can run ship.plan');
          console.assert(!policy.checkPromptAllowed('readonly', 'ship.patch'), 'readonly cannot run ship.patch');
          console.assert(policy.checkToolAllowed('engineer', 'Git'), 'engineer can use Git');
          console.assert(!policy.checkToolAllowed('readonly', 'Git'), 'readonly cannot use Git');

          // Test governance
          console.assert(gov.checkModelAllowed('engineer', 'claude-sonnet-4-6'), 'engineer can use claude');
          console.assert(!gov.checkModelAllowed('readonly', 'gpt-4o'), 'readonly cannot use gpt-4o');

          // Test data class
          const piiCheck = gov.checkDataClass('readonly', 'pii');
          console.assert(!piiCheck.allowed, 'readonly cannot access PII');

          // Test redaction
          const redacted = gov.redact('Contact: user@example.com for help', 'pii');
          console.assert(redacted.includes('[REDACTED]'), 'PII redacted');

          console.log('✅ All policy + governance tests passed');
          process.exit(0);
          EOF

  agent-eval:
    name: Agent Behavior Eval
    runs-on: ubuntu-latest
    needs: [policy-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Run agent eval suite (dry-run)
        run: node eval/runner.js --dry-run --output EVAL_RESULTS.md
      - name: Print eval results
        run: cat EVAL_RESULTS.md
      - name: Upload eval results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eval-results
          path: EVAL_RESULTS.md

  analytics-check:
    name: Analytics Structure Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Verify analytics module loads
        run: |
          node --input-type=module <<'EOF'
          import { Analytics } from './promptos-bridge/analytics.js';
          const a = new Analytics('/tmp/test-analytics');
          console.log('Analytics module loaded OK');
          const stats = a.getStats();
          console.log('Stats:', JSON.stringify(stats));
          console.assert(typeof stats.totalCalls === 'number', 'totalCalls is number');
          console.log('✅ Analytics check passed');
          EOF
